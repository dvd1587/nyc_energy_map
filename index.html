<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Buildings Energy & Water Use Map</title>
  <meta name="description" content="Explore NYC building energy and water performance data">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23141a16' width='100' height='100' rx='20'/><path fill='%2310b981' d='M25 85V30h20v55h-20zm30 0V15h20v70h-20z'/></svg>">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  
  <style>
    :root {
      --bg-primary: #0f1512;
      --bg-secondary: #141a16;
      --bg-tertiary: #1a221d;
      --border-color: #2a3830;
      --text-primary: #e8f0ec;
      --text-secondary: #9cb8a8;
      --text-muted: #5a7568;
      --accent-primary: #10b981;
      --accent-secondary: #34d399;
      --accent-tertiary: #6ee7b7;
      --accent-gradient: linear-gradient(135deg, #10b981, #34d399);
      --good: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }
    
    .app { display: flex; height: 100vh; }
    
    .sidebar {
      width: 400px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }
    
    .header-content { display: flex; align-items: center; gap: 14px; }
    
    .header-icon {
      width: 48px; height: 48px;
      background: var(--accent-gradient);
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.25);
    }
    
    .header h1 { font-size: 1.2rem; font-weight: 700; }
    .header p { font-size: 0.75rem; color: var(--text-secondary); margin-top: 3px; }
    .header a { color: var(--accent-secondary); text-decoration: none; }
    .header a:hover { text-decoration: underline; }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 14px 16px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }
    
    .stat-card {
      background: var(--bg-tertiary);
      padding: 10px 6px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-value { 
      font-size: 1.15rem; 
      font-weight: 700; 
      color: var(--text-muted);
    }
    .stat-value.good { color: #10b981 !important; }
    .stat-value.warning { color: #f59e0b !important; }
    .stat-value.danger { color: #ef4444 !important; }
    
    .stat-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.02em; margin-top: 2px; }
    .stat-unit { font-size: 0.55rem; color: var(--text-muted); margin-top: 1px; }
    .stat-sample { font-size: 0.5rem; color: var(--text-muted); margin-top: 2px; font-style: italic; }
    
    .tabs {
      display: flex;
      padding: 0 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      flex: 1; padding: 12px 4px;
      background: transparent; border: none;
      color: var(--text-muted); font-size: 0.7rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; position: relative;
    }
    
    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent-primary); }
    .tab.active::after {
      content: ''; position: absolute;
      bottom: 0; left: 10%; right: 10%; height: 3px;
      background: var(--accent-gradient); border-radius: 3px 3px 0 0;
    }
    
    .filters { flex: 1; overflow-y: auto; padding: 16px; }
    .filter-section { margin-bottom: 18px; }
    
    .filter-section-title {
      font-size: 0.65rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .filter-group { margin-bottom: 16px; }
    
    .filter-label {
      font-size: 0.8rem; font-weight: 500; color: var(--accent-secondary);
      margin-bottom: 8px; display: block;
    }
    
    .filter-select {
      width: 100%; padding: 10px 14px;
      background: var(--bg-tertiary); border: 1px solid var(--border-color);
      border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;
      cursor: pointer; transition: border-color 0.2s;
    }
    
    .filter-select:focus { outline: none; border-color: var(--accent-primary); }
    
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .checkbox-btn {
      padding: 8px 14px;
      background: var(--bg-tertiary); border: 1px solid var(--border-color);
      border-radius: 20px; color: var(--text-secondary); font-size: 0.8rem;
      cursor: pointer; transition: all 0.2s;
    }
    
    .checkbox-btn:hover { border-color: var(--accent-primary); color: var(--text-primary); }
    .checkbox-btn.active { background: var(--accent-gradient); border-color: transparent; color: #0f1a14; font-weight: 600; }
    
    .range-values { display: flex; justify-content: space-between; margin-bottom: 10px; }
    
    .range-input {
      background: var(--bg-tertiary); padding: 5px 10px;
      border-radius: 6px; font-size: 0.75rem;
      font-family: 'SF Mono', Monaco, monospace; color: var(--accent-secondary);
      border: 1px solid var(--border-color); min-width: 70px; text-align: center;
      width: 90px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .range-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    
    .range-input::selection {
      background: var(--accent-primary);
      color: white;
    }
    
    .dual-range {
      position: relative; height: 6px;
      background: var(--bg-tertiary); border-radius: 3px; margin: 14px 0;
    }
    
    .dual-range .track {
      position: absolute; height: 100%;
      background: var(--accent-gradient); border-radius: 3px;
    }
    
    .dual-range input[type="range"] {
      position: absolute; width: 100%; height: 6px;
      background: transparent; pointer-events: none;
      -webkit-appearance: none; top: 0;
    }
    
    .dual-range input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      background: var(--accent-primary); border-radius: 50%;
      cursor: pointer; border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      pointer-events: auto; margin-top: -6px;
    }
    
    .dual-range input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px;
      background: var(--accent-primary); border-radius: 50%;
      cursor: pointer; border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); pointer-events: auto;
    }
    
    .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    
    .toggle {
      width: 46px; height: 26px;
      background: var(--bg-tertiary); border-radius: 13px;
      position: relative; cursor: pointer; transition: background 0.3s;
      border: 1px solid var(--border-color);
    }
    
    .toggle.active { background: var(--accent-primary); border-color: var(--accent-primary); }
    
    .toggle::after {
      content: ''; position: absolute;
      top: 3px; left: 3px; width: 18px; height: 18px;
      background: white; border-radius: 50%;
      transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle.active::after { transform: translateX(20px); }
    
    .property-type-list { max-height: 280px; overflow-y: auto; }
    
    .property-type-row {
      display: flex; align-items: center; gap: 10px;
      padding: 6px 8px; margin: 2px 0;
      border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    
    .property-type-row:hover { background: var(--bg-tertiary); }
    
    .property-checkbox {
      width: 18px; height: 18px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    
    .property-checkbox.checked {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }
    
    .property-checkbox svg {
      width: 12px; height: 12px;
      stroke: white; stroke-width: 3;
      opacity: 0; transition: opacity 0.2s;
    }
    
    .property-checkbox.checked svg { opacity: 1; }
    
    .property-type-name {
      flex: 1; font-size: 0.75rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: var(--text-secondary);
    }
    
    .property-type-row:hover .property-type-name { color: var(--text-primary); }
    
    .property-type-count {
      font-size: 0.7rem; color: var(--text-muted); 
      font-family: monospace; min-width: 35px; text-align: right;
    }
    
    .select-all-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px; margin-bottom: 8px;
      background: var(--bg-tertiary); border-radius: 8px;
      cursor: pointer; border: 1px solid var(--border-color);
    }
    
    .select-all-row:hover { border-color: var(--accent-primary); }
    .select-all-row .property-type-name { font-weight: 600; color: var(--text-primary); }
    
    .other-types-row {
      padding: 6px 8px; margin: 2px 0;
      font-size: 0.7rem; color: var(--text-muted);
      font-style: italic;
    }
    
    .footer {
      padding: 14px 16px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-primary);
    }
    
    .footer-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .footer-stats-text { font-size: 0.8rem; color: var(--text-secondary); }
    .footer-stats-value { color: var(--accent-primary); font-weight: 700; }
    .footer-note { font-size: 0.65rem; color: var(--text-muted); margin-bottom: 10px; }
    
    .buttons { display: flex; gap: 10px; }
    
    .btn {
      flex: 1; padding: 11px; border: none;
      border-radius: 10px; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--border-color); }
    .btn-primary { background: var(--accent-gradient); color: #0f1a14; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35); }
    
    .copyright {
      margin-top: 12px; padding-top: 12px;
      border-top: 1px dashed var(--border-color);
      text-align: center;
      font-size: 0.65rem; color: var(--text-muted);
    }
    
    .map-area { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-primary); }
    
    .search-bar {
      padding: 14px 18px;
      background: rgba(15, 21, 18, 0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
    }
    
    .search-wrapper { position: relative; max-width: 500px; }
    
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      background: var(--bg-secondary); border: 1px solid var(--border-color);
      border-radius: 10px; color: var(--text-primary); font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .search-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .search-input::placeholder { color: var(--text-muted); }
    
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    
    #map { flex: 1; background: var(--bg-primary); }
    
    .loading-screen {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 20px; padding: 40px;
    }
    
    .loading-spinner {
      width: 60px; height: 60px;
      border: 4px solid var(--bg-tertiary); border-top-color: var(--accent-primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text { color: var(--text-secondary); font-size: 1rem; text-align: center; }
    .loading-subtext { color: var(--text-muted); font-size: 0.85rem; margin-top: -10px; text-align: center; max-width: 400px; }
    
    .loading-progress {
      width: 200px; height: 6px;
      background: var(--bg-tertiary); border-radius: 3px;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%; background: var(--accent-gradient);
      border-radius: 3px; transition: width 0.3s;
    }
    
    .error-icon {
      width: 80px; height: 80px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .error-title { font-size: 1.3rem; color: var(--danger); }
    .error-text { color: var(--text-secondary); max-width: 500px; text-align: center; line-height: 1.5; font-size: 0.9rem; }
    .error-details { color: var(--text-muted); font-size: 0.75rem; max-width: 600px; text-align: left; background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 10px; font-family: monospace; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; }
    
    .legend {
      position: absolute; bottom: 30px; right: 30px;
      background: rgba(20, 26, 22, 0.95); backdrop-filter: blur(10px);
      padding: 14px 18px; border-radius: 12px;
      border: 1px solid var(--border-color); z-index: 1000;
    }
    
    .legend-title {
      font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 8px;
      letter-spacing: 0.02em;
    }
    
    .legend-bar { display: flex; align-items: center; gap: 8px; }
    
    .legend-gradient {
      width: 130px; height: 10px;
      background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
      border-radius: 5px;
    }
    
    .legend-gradient.star { background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); }
    .legend-label { font-size: 0.65rem; color: var(--text-muted); }
    
    .leaflet-popup-content-wrapper {
      background: var(--bg-secondary); border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      border: 1px solid var(--border-color);
    }
    
    .leaflet-popup-content { margin: 0; color: var(--text-primary); }
    .leaflet-popup-tip { background: var(--bg-secondary); border: 1px solid var(--border-color); }
    
    .popup { padding: 16px; min-width: 280px; }
    .popup-header { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
    .popup-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 3px; }
    .popup-address { font-size: 0.8rem; color: var(--text-secondary); }
    .popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .popup-item { background: var(--bg-tertiary); padding: 8px 10px; border-radius: 6px; }
    .popup-item-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
    .popup-item-value { font-size: 0.85rem; font-weight: 600; }
    .popup-item-value.good { color: var(--good); }
    .popup-item-value.warning { color: var(--warning); }
    .popup-item-value.danger { color: var(--danger); }
    
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    
    .leaflet-control-zoom a { background: var(--bg-secondary) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }
    .leaflet-control-zoom a:hover { background: var(--bg-tertiary) !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="header">
        <div class="header-content">
          <div class="header-icon">
            <svg width="26" height="26" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/>
            </svg>
          </div>
          <div>
            <h1>NYC Buildings Energy & Water Use Map</h1>
            <p>Local Law 84 Data Disclosure: <a href="https://data.cityofnewyork.us/Environment/NYC-Building-Energy-and-Water-Data-Disclosure-for-/5zyy-y8am" target="_blank">NYC Open Data</a></p>
            <p><small><i>Last Updated: November 2025</i></small></p>
            </div>
        </div>
      </div>
      
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="avgEui">--</div>
          <div class="stat-label">AVG EUI</div>
          <div class="stat-unit">(kBtu/ft²)</div>
          <div class="stat-sample" id="euiSample"></div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgWui">--</div>
          <div class="stat-label">AVG WUI</div>
          <div class="stat-unit">(gal/ft²)</div>
          <div class="stat-sample" id="wuiSample"></div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgGhg">--</div>
          <div class="stat-label">AVG GHG</div>
          <div class="stat-unit">(kgCO₂e/ft²)</div>
          <div class="stat-sample" id="ghgSample"></div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgStar">--</div>
          <div class="stat-label">AVG ENERGY STAR®</div>
          <div class="stat-unit">(1-100)</div>
          <div class="stat-sample" id="starSample"></div>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-metric="eui">Energy (EUI)</button>
        <button class="tab" data-metric="wui">Water (WUI)</button>
        <button class="tab" data-metric="ghg">Emissions (GHG)</button>
        <button class="tab" data-metric="star">ENERGY STAR®</button>
      </div>
      
      <div class="filters">
        <div class="filter-section">
          <div class="filter-section-title">Location</div>
          
          <div class="filter-group">
            <label class="filter-label">Borough</label>
            <div class="checkbox-group" id="boroughFilter">
              <button class="checkbox-btn active" data-borough="">All</button>
              <button class="checkbox-btn" data-borough="Manhattan">Manhattan</button>
              <button class="checkbox-btn" data-borough="Brooklyn">Brooklyn</button>
              <button class="checkbox-btn" data-borough="Queens">Queens</button>
              <button class="checkbox-btn" data-borough="Bronx">Bronx</button>
              <button class="checkbox-btn" data-borough="Staten Island">Staten Island</button>
            </div>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Reporting Year</label>
            <select class="filter-select" id="yearFilter">
              <option value="2024">2024</option>
            </select>
          </div>
        </div>
        
        <div class="filter-section">
          <div class="filter-section-title">Building Characteristics</div>
          
          <div class="filter-group">
            <label class="filter-label">Year Built</label>
            <div class="range-values">
              <input type="text" class="range-input" id="yearBuiltMinInput" value="--">
              <input type="text" class="range-input" id="yearBuiltMaxInput" value="--">
            </div>
            <div class="dual-range">
              <div class="track" id="yearBuiltTrack"></div>
              <input type="range" id="yearBuiltMin" min="1700" max="2025" value="1700">
              <input type="range" id="yearBuiltMax" min="1700" max="2025" value="2025">
            </div>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Floor Area (ft²)</label>
            <div class="range-values">
              <input type="text" class="range-input" id="floorAreaMinInput" value="--">
              <input type="text" class="range-input" id="floorAreaMaxInput" value="--">
            </div>
            <div class="dual-range">
              <div class="track" id="floorAreaTrack"></div>
              <input type="range" id="floorAreaMin" min="0" max="15000000" step="10000" value="0">
              <input type="range" id="floorAreaMax" min="0" max="15000000" step="10000" value="15000000">
            </div>
          </div>
        </div>
        
        <div class="filter-section">
          <div class="filter-section-title">Performance Metrics</div>
          
          <div class="filter-group">
            <label class="filter-label">ENERGY STAR® Rating</label>
            <div class="range-values">
              <input type="text" class="range-input" id="starMinInput" value="1">
              <input type="text" class="range-input" id="starMaxInput" value="100">
            </div>
            <div class="dual-range">
              <div class="track" id="starTrack"></div>
              <input type="range" id="starMin" min="1" max="100" value="1">
              <input type="range" id="starMax" min="1" max="100" value="100">
            </div>
          </div>
          
          <div class="toggle-row">
            <span class="filter-label" style="margin:0">Only ENERGY STAR® Rated</span>
            <div class="toggle" id="energyStarToggle"></div>
          </div>
        </div>
        
        <div class="filter-section">
          <div class="filter-section-title">Property Types</div>
          <div class="property-type-list" id="propertyTypes"></div>
        </div>
      </div>
      
      <div class="footer">
        <div class="footer-stats">
          <span class="footer-stats-text">Showing</span>
          <span class="footer-stats-value">
            <span id="filteredCount">0</span> of <span id="totalCount">0</span> buildings
          </span>
        </div>
        <div class="footer-note" id="footerNote"></div>
        <div class="buttons">
          <button class="btn btn-secondary" id="downloadBtn">Export Data</button>
          <button class="btn btn-primary" id="resetBtn">Reset All</button>
        </div>
        
        <div class="copyright">
          <p>© 2026 <a href="https://github.com/dvd1587" target="_blank">Prateek Dwivedi</a></p>
        </div>
      </div>
    </div>
    
    <div class="map-area">
      <div class="search-bar">
        <div class="search-wrapper">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search by building name or address...">
        </div>
      </div>
      
      <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading NYC Building Data...</div>
        <div class="loading-subtext" id="loadingSubtext">Connecting to NYC Open Data API</div>
        <div class="loading-progress">
          <div class="loading-progress-bar" id="loadingProgress" style="width: 0%"></div>
        </div>
      </div>
      
      <div id="map" style="display:none"></div>
      
      <div class="legend" id="legend" style="display:none">
        <div class="legend-title" id="legendTitle">Source EUI (kBtu/ft²)</div>
        <div class="legend-bar">
          <span class="legend-label" id="legendLowLabel">Good</span>
          <div class="legend-gradient" id="legendGradient"></div>
          <span class="legend-label" id="legendHighLabel">Poor</span>
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================================================
// SODA 3.0 API Configuration
// ============================================================================
const API_URL = 'https://data.cityofnewyork.us/api/v3/views/5zyy-y8am/query.json';
const APP_TOKEN = '5U3PdX83pjEizBSCi3g28npTj';
const PAGE_SIZE = 50000;

const SELECT_FIELDS = [
  'property_id', 'property_name', 'address_1', 'borough',
  'nyc_borough_block_and_lot', 'nyc_building_identification',
  'latitude', 'longitude', 'year_built',
  'primary_property_type_self', 'largest_property_use_type',
  'property_gfa_self_reported', 'property_gfa_calculated',
  'site_eui_kbtu_ft', 'source_eui_kbtu_ft',
  'energy_star_score', 'total_location_based_ghg_1',
  'water_use_all_water_sources', 'report_year'
].join(', ');

const METRICS = {
  eui: { label: 'Source EUI (kBtu/ft²)', field: 'sourceEui', unit: 'kBtu/ft²', goodThreshold: 100, badThreshold: 200, lowerIsBetter: true },
  wui: { label: 'Water Use Intensity (gal/ft²)', field: 'wui', unit: 'gal/ft²', goodThreshold: 30, badThreshold: 80, lowerIsBetter: true },
  ghg: { label: 'GHG Intensity (kgCO₂e/ft²)', field: 'ghgIntensity', unit: 'kgCO₂e/ft²', goodThreshold: 5, badThreshold: 10, lowerIsBetter: true },
  star: { label: 'ENERGY STAR® Rating (1-100)', field: 'energyStarScore', unit: '1-100', goodThreshold: 75, badThreshold: 50, lowerIsBetter: false }
};

let dataRanges = { 
  yearBuilt: { min: 1700, max: 2025 }, 
  floorArea: { min: 0, max: 15000000 } 
};

// ============================================================================
// STATE
// ============================================================================
let allBuildings = [];
let filteredBuildings = [];
let excludedCount = 0;
let map = null;
let markersLayer = null;
let currentMetric = 'eui';
let allPropertyTypes = [];
let selectAllActive = true;
let availableYears = [];
let defaultYear = '2024';

let filters = {
  borough: '', year: '2024',
  yearBuiltMin: 1700, yearBuiltMax: 2025,
  floorAreaMin: 0, floorAreaMax: 15000000,
  starMin: 1, starMax: 100,
  energyStarOnly: false, search: '', selectedTypes: []
};

// ============================================================================
// UTILITIES
// ============================================================================
function parseNum(val) {
  if (val === null || val === undefined) return null;
  if (typeof val === 'number') return isNaN(val) ? null : val;
  const str = String(val).trim();
  if (str === '' || str.toLowerCase() === 'not available' || str.toLowerCase() === 'n/a') return null;
  const num = parseFloat(str.replace(/,/g, ''));
  return isNaN(num) ? null : num;
}

function formatNum(n, dec = 0) {
  if (n === null || n === undefined) return 'N/A';
  return n.toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec });
}

function formatYear(n) {
  if (n === null || n === undefined) return 'N/A';
  return String(Math.round(n));
}

function normalizeBorough(borough) {
  if (!borough) return 'Unknown';
  const b = borough.trim().toUpperCase();
  
  if (b === 'MANHATTAN' || b === 'MN' || b === 'NEW YORK' || b === 'NY') return 'Manhattan';
  if (b === 'BROOKLYN' || b === 'BK' || b === 'KINGS') return 'Brooklyn';
  if (b === 'QUEENS' || b === 'QN' || b === 'QNS') return 'Queens';
  if (b === 'BRONX' || b === 'THE BRONX' || b === 'BX') return 'Bronx';
  if (b === 'STATEN ISLAND' || b === 'SI' || b === 'RICHMOND' || b === 'STATEN IS' || b === 'STATEN IS.') return 'Staten Island';
  
  return 'Unknown';
}

function getMarkerColor(value, metric) {
  if (value === null || value === undefined) return '#6b7280';
  const m = METRICS[metric];
  if (m.lowerIsBetter) {
    if (value <= m.goodThreshold) return '#10b981';
    if (value >= m.badThreshold) return '#ef4444';
    const ratio = (value - m.goodThreshold) / (m.badThreshold - m.goodThreshold);
    return `rgb(${Math.round(245 + ratio * (234 - 245))},${Math.round(158 - ratio * 70)},${Math.round(11 + ratio)})`;
  } else {
    if (value >= m.goodThreshold) return '#10b981';
    if (value <= m.badThreshold) return '#ef4444';
    const ratio = (value - m.badThreshold) / (m.goodThreshold - m.badThreshold);
    return `rgb(${Math.round(234 + ratio * 11)},${Math.round(88 + ratio * 70)},${Math.round(12 - ratio)})`;
  }
}

function getValueClass(value, metric) {
  if (value === null || value === undefined) return '';
  const m = METRICS[metric];
  if (m.lowerIsBetter) {
    if (value <= m.goodThreshold) return 'good';
    if (value >= m.badThreshold) return 'danger';
    return 'warning';
  } else {
    if (value >= m.goodThreshold) return 'good';
    if (value <= m.badThreshold) return 'danger';
    return 'warning';
  }
}

// ============================================================================
// SODA 3.0 API
// ============================================================================
async function fetchPage(pageNumber) {
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-App-Token': APP_TOKEN
    },
    body: JSON.stringify({
      query: `SELECT ${SELECT_FIELDS}`,
      page: {
        pageNumber: pageNumber,
        pageSize: PAGE_SIZE
      },
      includeSynthetic: false
    })
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    console.error('API Error Response:', errorText);
    throw new Error(`API error: ${response.status} ${response.statusText}`);
  }
  
  const responseText = await response.text();
  
  if (!responseText || responseText.trim() === '') {
    throw new Error('Empty response from API');
  }
  
  return JSON.parse(responseText);
}

async function fetchAllData() {
  const loadingText = document.getElementById('loadingSubtext');
  const progressBar = document.getElementById('loadingProgress');
  
  try {
    let allData = [];
    let pageNumber = 1;
    
    while (true) {
      loadingText.textContent = `Loading page ${pageNumber}... (${allData.length.toLocaleString()} records)`;
      progressBar.style.width = `${Math.min(90, pageNumber * 8)}%`;
      
      const response = await fetchPage(pageNumber);
      
      let pageData = [];
      if (Array.isArray(response)) {
        pageData = response;
      } else if (response && Array.isArray(response.data)) {
        pageData = response.data;
      } else if (response && Array.isArray(response.rows)) {
        pageData = response.rows;
      } else {
        for (const key of Object.keys(response || {})) {
          if (Array.isArray(response[key])) {
            pageData = response[key];
            break;
          }
        }
      }
      
      if (pageData.length === 0) break;
      
      allData = allData.concat(pageData);
      
      if (pageData.length < PAGE_SIZE) break;
      
      pageNumber++;
      
      await new Promise(resolve => setTimeout(resolve, 50));
    }
    
    loadingText.textContent = 'Processing data...';
    progressBar.style.width = '95%';
    
    const buildings = transformApiData(allData);
    
    progressBar.style.width = '100%';
    loadingText.textContent = `Loaded ${buildings.length.toLocaleString()} buildings`;
    
    return buildings;
    
  } catch (error) {
    console.error('API fetch error:', error);
    throw error;
  }
}

function transformApiData(data) {
  const results = [];
  let noCoords = 0, invalidCoords = 0;
  
  data.forEach((row, i) => {
    const lat = parseNum(row.latitude);
    const lng = parseNum(row.longitude);
    
    if (lat === null || lng === null) { noCoords++; return; }
    if (lat < 40.4 || lat > 41.0 || lng < -74.3 || lng > -73.5) { invalidCoords++; return; }
    
    const gfa = parseNum(row.property_gfa_self_reported) || 
                parseNum(row.property_gfa_calculated);
    
    const waterUse = parseNum(row.water_use_all_water_sources);
    let wui = null;
    if (waterUse !== null && gfa !== null && gfa > 0) {
      wui = (waterUse * 1000) / gfa;
    }
    
    let propType = row.primary_property_type_self || row.largest_property_use_type;
    if (!propType || propType.trim() === '' || propType.toLowerCase() === 'n/a' || propType.toLowerCase() === 'not available') {
      propType = 'Not Specified';
    }
    
    results.push({
      id: row.property_id || `bldg-${i}`,
      name: row.property_name || 'Unknown Building',
      address: row.address_1 || '',
      borough: normalizeBorough(row.borough),
      bbl: row.nyc_borough_block_and_lot || '',
      bin: row.nyc_building_identification || '',
      lat, lng,
      yearBuilt: parseNum(row.year_built),
      propertyType: propType,
      floorArea: gfa,
      siteEui: parseNum(row.site_eui_kbtu_ft),
      sourceEui: parseNum(row.source_eui_kbtu_ft),
      wui: wui,
      ghgIntensity: parseNum(row.total_location_based_ghg_1),
      energyStarScore: parseNum(row.energy_star_score),
      dataYear: row.report_year || ''
    });
  });
  
  excludedCount = noCoords + invalidCoords;
  
  return results;
}

// ============================================================================
// UI COMPONENTS & HELPERS
// ============================================================================
function calculateDataRanges() {
  const yearBuilts = allBuildings.map(b => b.yearBuilt).filter(v => v !== null);
  const floorAreas = allBuildings.map(b => b.floorArea).filter(v => v !== null && v >= 0);
  
  if (yearBuilts.length > 0) {
    dataRanges.yearBuilt = { 
      min: Math.min(...yearBuilts), 
      max: Math.max(...yearBuilts) 
    };
  }
  if (floorAreas.length > 0) {
    dataRanges.floorArea = { 
      min: 0,
      max: Math.ceil(Math.max(...floorAreas) / 1000000) * 1000000 
    };
  }
  
  allPropertyTypes = [...new Set(allBuildings.map(b => b.propertyType).filter(Boolean))].sort();
}

// ============================================================================
// DUAL RANGE SLIDER WITH EDITABLE INPUTS
// ============================================================================
function setupDualRangeWithInputs(config) {
  const {
    minSliderId, maxSliderId, minInputId, maxInputId, trackId,
    rangeMin, rangeMax, step, formatDisplay, parseInput, onChange
  } = config;
  
  const minSlider = document.getElementById(minSliderId);
  const maxSlider = document.getElementById(maxSliderId);
  const minInput = document.getElementById(minInputId);
  const maxInput = document.getElementById(maxInputId);
  const track = document.getElementById(trackId);
  
  let currentMin = rangeMin;
  let currentMax = rangeMax;
  
  function clamp(val, min, max) {
    return Math.max(min, Math.min(max, val));
  }
  
  function updateTrack() {
    const sliderMin = parseFloat(minSlider.min);
    const sliderMax = parseFloat(minSlider.max);
    const leftPct = ((currentMin - sliderMin) / (sliderMax - sliderMin)) * 100;
    const rightPct = ((currentMax - sliderMin) / (sliderMax - sliderMin)) * 100;
    track.style.left = leftPct + '%';
    track.style.width = (rightPct - leftPct) + '%';
  }
  
  function updateDisplay() {
    minInput.value = formatDisplay(currentMin);
    maxInput.value = formatDisplay(currentMax);
    minSlider.value = currentMin;
    maxSlider.value = currentMax;
    updateTrack();
  }
  
  function applyValues(newMin, newMax, triggerChange = true) {
    // Clamp to valid range
    newMin = clamp(newMin, parseFloat(minSlider.min), parseFloat(minSlider.max));
    newMax = clamp(newMax, parseFloat(minSlider.min), parseFloat(minSlider.max));
    
    // Ensure min <= max
    if (newMin > newMax) {
      const temp = newMin;
      newMin = newMax;
      newMax = temp;
    }
    
    currentMin = newMin;
    currentMax = newMax;
    updateDisplay();
    
    if (triggerChange) {
      onChange(currentMin, currentMax);
    }
  }
  
  // Slider events
  minSlider.addEventListener('input', () => {
    let val = parseFloat(minSlider.value);
    if (val > currentMax) val = currentMax;
    applyValues(val, currentMax);
  });
  
  maxSlider.addEventListener('input', () => {
    let val = parseFloat(maxSlider.value);
    if (val < currentMin) val = currentMin;
    applyValues(currentMin, val);
  });
  
  // Input field events
  function handleInputChange(inputEl, isMin) {
    const parsed = parseInput(inputEl.value);
    if (parsed !== null && !isNaN(parsed)) {
      if (isMin) {
        applyValues(parsed, currentMax);
      } else {
        applyValues(currentMin, parsed);
      }
    } else {
      // Invalid input - restore previous value
      updateDisplay();
    }
  }
  
  minInput.addEventListener('blur', () => handleInputChange(minInput, true));
  maxInput.addEventListener('blur', () => handleInputChange(maxInput, false));
  
  minInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleInputChange(minInput, true);
      minInput.blur();
    }
  });
  
  maxInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleInputChange(maxInput, false);
      maxInput.blur();
    }
  });
  
  // Select all on focus
  minInput.addEventListener('focus', () => minInput.select());
  maxInput.addEventListener('focus', () => maxInput.select());
  
  return {
    setRange: (min, max, newStep) => {
      minSlider.min = min;
      minSlider.max = max;
      minSlider.step = newStep || step || 1;
      maxSlider.min = min;
      maxSlider.max = max;
      maxSlider.step = newStep || step || 1;
      applyValues(min, max, false);
    },
    set: (min, max) => {
      applyValues(min, max, false);
    },
    get: () => ({ min: currentMin, max: currentMax })
  };
}

let sliders = {};

function initUI() {
  // Year Built slider with editable inputs
  sliders.yearBuilt = setupDualRangeWithInputs({
    minSliderId: 'yearBuiltMin',
    maxSliderId: 'yearBuiltMax',
    minInputId: 'yearBuiltMinInput',
    maxInputId: 'yearBuiltMaxInput',
    trackId: 'yearBuiltTrack',
    rangeMin: 1700,
    rangeMax: 2025,
    step: 1,
    formatDisplay: (val) => Math.round(val).toString(),
    parseInput: (val) => {
      const num = parseInt(val.replace(/,/g, ''), 10);
      return isNaN(num) ? null : num;
    },
    onChange: (min, max) => {
      filters.yearBuiltMin = min;
      filters.yearBuiltMax = max;
      applyFilters();
    }
  });
  
  // Floor Area slider with editable inputs
  sliders.floorArea = setupDualRangeWithInputs({
    minSliderId: 'floorAreaMin',
    maxSliderId: 'floorAreaMax',
    minInputId: 'floorAreaMinInput',
    maxInputId: 'floorAreaMaxInput',
    trackId: 'floorAreaTrack',
    rangeMin: 0,
    rangeMax: 15000000,
    step: 10000,
    formatDisplay: (val) => Math.round(val).toLocaleString(),
    parseInput: (val) => {
      const num = parseInt(val.replace(/,/g, ''), 10);
      return isNaN(num) ? null : num;
    },
    onChange: (min, max) => {
      filters.floorAreaMin = min;
      filters.floorAreaMax = max;
      applyFilters();
    }
  });
  
  // ENERGY STAR Rating slider with editable inputs
  sliders.star = setupDualRangeWithInputs({
    minSliderId: 'starMin',
    maxSliderId: 'starMax',
    minInputId: 'starMinInput',
    maxInputId: 'starMaxInput',
    trackId: 'starTrack',
    rangeMin: 1,
    rangeMax: 100,
    step: 1,
    formatDisplay: (val) => Math.round(val).toString(),
    parseInput: (val) => {
      const num = parseInt(val.replace(/,/g, ''), 10);
      return isNaN(num) ? null : num;
    },
    onChange: (min, max) => {
      filters.starMin = min;
      filters.starMax = max;
      applyFilters();
    }
  });
  
  document.getElementById('boroughFilter').addEventListener('click', e => {
    if (e.target.classList.contains('checkbox-btn')) {
      document.querySelectorAll('#boroughFilter .checkbox-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      filters.borough = e.target.dataset.borough;
      applyFilters();
    }
  });
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentMetric = tab.dataset.metric;
      updateLegend();
      updateMap();
    });
  });
  
  document.getElementById('yearFilter').addEventListener('change', e => { 
    filters.year = e.target.value; 
    applyFilters(); 
  });
  
  document.getElementById('energyStarToggle').addEventListener('click', function() {
    this.classList.toggle('active');
    filters.energyStarOnly = this.classList.contains('active');
    applyFilters();
  });
  
  let searchTimer;
  document.getElementById('searchInput').addEventListener('input', e => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { filters.search = e.target.value; applyFilters(); }, 300);
  });
  
  document.getElementById('resetBtn').addEventListener('click', resetFilters);
  document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
}

function updateSlidersFromData() {
  sliders.yearBuilt.setRange(dataRanges.yearBuilt.min, dataRanges.yearBuilt.max, 1);
  filters.yearBuiltMin = dataRanges.yearBuilt.min;
  filters.yearBuiltMax = dataRanges.yearBuilt.max;
  
  sliders.floorArea.setRange(dataRanges.floorArea.min, dataRanges.floorArea.max, 10000);
  filters.floorAreaMin = dataRanges.floorArea.min;
  filters.floorAreaMax = dataRanges.floorArea.max;
  
  sliders.star.setRange(1, 100, 1);
  filters.starMin = 1;
  filters.starMax = 100;
}

function updateLegend() {
  const m = METRICS[currentMetric];
  document.getElementById('legendTitle').textContent = m.label;
  const gradient = document.getElementById('legendGradient');
  if (currentMetric === 'star') {
    gradient.className = 'legend-gradient star';
    document.getElementById('legendLowLabel').textContent = 'Poor';
    document.getElementById('legendHighLabel').textContent = 'Good';
  } else {
    gradient.className = 'legend-gradient';
    document.getElementById('legendLowLabel').textContent = 'Good';
    document.getElementById('legendHighLabel').textContent = 'Poor';
  }
}

function updateStats() {
  const withEui = filteredBuildings.filter(b => b.sourceEui !== null && b.sourceEui > 0 && b.sourceEui < 10000);
  const withWui = filteredBuildings.filter(b => b.wui !== null && b.wui > 0 && b.wui < 1000);
  const withGhg = filteredBuildings.filter(b => b.ghgIntensity !== null && b.ghgIntensity > 0 && b.ghgIntensity < 100);
  const withStar = filteredBuildings.filter(b => b.energyStarScore !== null && b.energyStarScore >= 1 && b.energyStarScore <= 100);
  
  const avgEui = withEui.length > 0 ? withEui.reduce((s, b) => s + b.sourceEui, 0) / withEui.length : null;
  const avgWui = withWui.length > 0 ? withWui.reduce((s, b) => s + b.wui, 0) / withWui.length : null;
  const avgGhg = withGhg.length > 0 ? withGhg.reduce((s, b) => s + b.ghgIntensity, 0) / withGhg.length : null;
  const avgStar = withStar.length > 0 ? withStar.reduce((s, b) => s + b.energyStarScore, 0) / withStar.length : null;
  
  const euiEl = document.getElementById('avgEui');
  euiEl.textContent = avgEui ? avgEui.toFixed(0) : '--';
  euiEl.className = 'stat-value';
  if (avgEui !== null) euiEl.classList.add(getValueClass(avgEui, 'eui'));
  document.getElementById('euiSample').textContent = `n=${withEui.length.toLocaleString()}`;
  
  const wuiEl = document.getElementById('avgWui');
  wuiEl.textContent = avgWui ? avgWui.toFixed(1) : '--';
  wuiEl.className = 'stat-value';
  if (avgWui !== null) wuiEl.classList.add(getValueClass(avgWui, 'wui'));
  document.getElementById('wuiSample').textContent = `n=${withWui.length.toLocaleString()}`;
  
  const ghgEl = document.getElementById('avgGhg');
  ghgEl.textContent = avgGhg ? avgGhg.toFixed(1) : '--';
  ghgEl.className = 'stat-value';
  if (avgGhg !== null) ghgEl.classList.add(getValueClass(avgGhg, 'ghg'));
  document.getElementById('ghgSample').textContent = `n=${withGhg.length.toLocaleString()}`;
  
  const starEl = document.getElementById('avgStar');
  starEl.textContent = avgStar ? avgStar.toFixed(0) : '--';
  starEl.className = 'stat-value';
  if (avgStar !== null) starEl.classList.add(getValueClass(avgStar, 'star'));
  document.getElementById('starSample').textContent = `n=${withStar.length.toLocaleString()}`;
  
  const yearTotal = allBuildings.filter(b => b.dataYear == filters.year).length;
  document.getElementById('filteredCount').textContent = formatNum(filteredBuildings.length);
  document.getElementById('totalCount').textContent = formatNum(yearTotal);
  
  if (excludedCount > 0) {
    document.getElementById('footerNote').textContent = `${excludedCount.toLocaleString()} records excluded (missing/invalid coordinates)`;
  }
}

function updateYearDropdown() {
  availableYears = [...new Set(allBuildings.map(b => b.dataYear).filter(Boolean))].sort((a, b) => b - a);
  
  if (availableYears.length > 0) {
    defaultYear = availableYears[0];
    filters.year = defaultYear;
  }
  
  const select = document.getElementById('yearFilter');
  select.innerHTML = availableYears.map(y => `<option value="${y}"${y === defaultYear ? ' selected' : ''}>${y}</option>`).join('');
}

function updatePropertyTypes() {
  const counts = {};
  filteredBuildings.forEach(b => { 
    const type = b.propertyType || 'Not Specified';
    counts[type] = (counts[type] || 0) + 1; 
  });
  
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const top20 = sorted.slice(0, 20);
  const otherTypes = sorted.slice(20);
  const otherCount = otherTypes.reduce((sum, [, count]) => sum + count, 0);
  
  const checkIcon = `<svg viewBox="0 0 24 24" fill="none"><path d="M5 12l5 5L20 7" stroke="currentColor"/></svg>`;
  
  let html = `<div class="select-all-row" onclick="toggleSelectAll()">
    <div class="property-checkbox ${selectAllActive ? 'checked' : ''}">${checkIcon}</div>
    <span class="property-type-name">Select All</span>
    <span class="property-type-count">${filteredBuildings.length.toLocaleString()}</span>
  </div>`;
  
  html += top20.map(([type, count]) => {
    const isChecked = selectAllActive || filters.selectedTypes.includes(type);
    const safeType = type.replace(/'/g, "\\'").replace(/"/g, '\\"');
    return `<div class="property-type-row" onclick="togglePropertyType('${safeType}')">
      <div class="property-checkbox ${isChecked ? 'checked' : ''}" ${selectAllActive ? 'style="opacity:0.5"' : ''}>${checkIcon}</div>
      <span class="property-type-name" title="${type}">${type}</span>
      <span class="property-type-count">${count.toLocaleString()}</span>
    </div>`;
  }).join('');
  
  if (otherCount > 0) {
    html += `<div class="other-types-row">+ ${otherTypes.length} other types (${otherCount.toLocaleString()} buildings)</div>`;
  }
  
  document.getElementById('propertyTypes').innerHTML = html;
}

function toggleSelectAll() {
  selectAllActive = !selectAllActive;
  if (selectAllActive) filters.selectedTypes = [];
  applyFilters();
}

function togglePropertyType(type) {
  if (selectAllActive) {
    selectAllActive = false;
    filters.selectedTypes = [type];
  } else {
    const idx = filters.selectedTypes.indexOf(type);
    if (idx >= 0) {
      filters.selectedTypes.splice(idx, 1);
      if (filters.selectedTypes.length === 0) selectAllActive = true;
    } else {
      filters.selectedTypes.push(type);
    }
  }
  applyFilters();
}

function applyFilters() {
  let baseData = allBuildings.filter(b => b.dataYear == filters.year);
  
  filteredBuildings = baseData.filter(b => {
    if (filters.borough && b.borough !== filters.borough) return false;
    
    if (b.yearBuilt !== null) {
      if (b.yearBuilt < filters.yearBuiltMin || b.yearBuilt > filters.yearBuiltMax) return false;
    }
    
    if (b.floorArea !== null) {
      if (b.floorArea < filters.floorAreaMin || b.floorArea > filters.floorAreaMax) return false;
    }
    
    if (b.energyStarScore !== null) {
      if (b.energyStarScore < filters.starMin || b.energyStarScore > filters.starMax) return false;
    }
    
    if (filters.energyStarOnly && b.energyStarScore === null) return false;
    
    if (!selectAllActive && filters.selectedTypes.length > 0 && !filters.selectedTypes.includes(b.propertyType)) return false;
    
    if (filters.search) {
      const q = filters.search.toLowerCase();
      const text = [b.name, b.address, b.bbl].filter(Boolean).join(' ').toLowerCase();
      if (!text.includes(q)) return false;
    }
    
    return true;
  });
  
  updateStats();
  updatePropertyTypes();
  updateMap();
}

function resetFilters() {
  filters = {
    borough: '', year: defaultYear,
    yearBuiltMin: dataRanges.yearBuilt.min, yearBuiltMax: dataRanges.yearBuilt.max,
    floorAreaMin: dataRanges.floorArea.min, floorAreaMax: dataRanges.floorArea.max,
    starMin: 1, starMax: 100, energyStarOnly: false, search: '', selectedTypes: []
  };
  selectAllActive = true;
  
  document.querySelectorAll('#boroughFilter .checkbox-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('#boroughFilter .checkbox-btn[data-borough=""]').classList.add('active');
  document.getElementById('yearFilter').value = defaultYear;
  document.getElementById('searchInput').value = '';
  document.getElementById('energyStarToggle').classList.remove('active');
  
  updateSlidersFromData();
  applyFilters();
}

function initMap() {
  map = L.map('map').setView([40.7128, -74.006], 11);
  
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '© OpenStreetMap © CARTO', maxZoom: 19
  }).addTo(map);
  
  markersLayer = L.markerClusterGroup({
    maxClusterRadius: 50, spiderfyOnMaxZoom: true, showCoverageOnHover: false,
    iconCreateFunction: cluster => {
      const count = cluster.getChildCount();
      const size = count > 100 ? 52 : count > 10 ? 44 : 36;
      return L.divIcon({
        html: `<div style="background:linear-gradient(135deg,#10b981,#34d399);width:${size}px;height:${size}px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#0f1a14;font-weight:700;font-size:${count>100?13:11}px;border:3px solid rgba(255,255,255,0.9);box-shadow:0 4px 12px rgba(16,185,129,0.35)">${count}</div>`,
        className: '', iconSize: [size, size]
      });
    }
  });
  
  map.addLayer(markersLayer);
}

function updateMap() {
  if (!map || !markersLayer) return;
  markersLayer.clearLayers();
  
  const m = METRICS[currentMetric];
  
  filteredBuildings.forEach(b => {
    const val = b[m.field];
    const color = getMarkerColor(val, currentMetric);
    
    const marker = L.circleMarker([b.lat, b.lng], {
      radius: 7, fillColor: color, color: 'rgba(255,255,255,0.8)', weight: 2, fillOpacity: 0.9
    });
    
    marker.bindPopup(`<div class="popup">
      <div class="popup-header">
        <div class="popup-title">${b.name}</div>
        <div class="popup-address">${b.address}${b.borough ? ', ' + b.borough : ''}</div>
      </div>
      <div class="popup-grid">
        <div class="popup-item"><div class="popup-item-label">Type</div><div class="popup-item-value">${b.propertyType}</div></div>
        <div class="popup-item"><div class="popup-item-label">Year Built</div><div class="popup-item-value">${b.yearBuilt || 'N/A'}</div></div>
        <div class="popup-item"><div class="popup-item-label">Floor Area</div><div class="popup-item-value">${formatNum(b.floorArea)} ft²</div></div>
        <div class="popup-item"><div class="popup-item-label">Source EUI</div><div class="popup-item-value ${getValueClass(b.sourceEui, 'eui')}">${b.sourceEui ? b.sourceEui.toFixed(1) : 'N/A'}</div></div>
        <div class="popup-item"><div class="popup-item-label">Water Use</div><div class="popup-item-value ${getValueClass(b.wui, 'wui')}">${b.wui ? b.wui.toFixed(1) : 'N/A'}</div></div>
        <div class="popup-item"><div class="popup-item-label">GHG</div><div class="popup-item-value ${getValueClass(b.ghgIntensity, 'ghg')}">${b.ghgIntensity ? b.ghgIntensity.toFixed(2) : 'N/A'}</div></div>
        <div class="popup-item"><div class="popup-item-label">ENERGY STAR®</div><div class="popup-item-value ${getValueClass(b.energyStarScore, 'star')}">${b.energyStarScore || 'N/A'}</div></div>
        <div class="popup-item"><div class="popup-item-label">Report Year</div><div class="popup-item-value">${b.dataYear || 'N/A'}</div></div>
      </div>
    </div>`);
    
    markersLayer.addLayer(marker);
  });
}

function showMap() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('map').style.display = 'block';
  document.getElementById('legend').style.display = 'block';
  if (!map) initMap();
}

function showError(message, details = '') {
  document.getElementById('loadingScreen').innerHTML = `
    <div class="error-icon">
      <svg width="40" height="40" fill="none" stroke="#ef4444" stroke-width="1.5" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
      </svg>
    </div>
    <div class="error-title">Error Loading Data</div>
    <div class="error-text">${message}</div>
    ${details ? `<div class="error-details">${details}</div>` : ''}
    <button class="btn btn-primary" style="margin-top:20px;max-width:200px" onclick="location.reload()">Retry</button>
  `;
}

function downloadCSV() {
  if (filteredBuildings.length === 0) return;
  
  const headers = ['Name','Address','Borough','BBL','Type','Year Built','Floor Area','Site EUI','Source EUI','WUI','GHG Intensity','ENERGY STAR Rating','Report Year','Lat','Lng'];
  const rows = filteredBuildings.map(b => [
    b.name, b.address, b.borough, b.bbl, b.propertyType, b.yearBuilt, b.floorArea,
    b.siteEui?.toFixed(1), b.sourceEui?.toFixed(1), b.wui?.toFixed(2),
    b.ghgIntensity?.toFixed(2), b.energyStarScore, b.dataYear, b.lat, b.lng
  ]);
  
  const csv = [headers, ...rows].map(r => r.map(c => `"${c ?? ''}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nyc_building_energy_${filters.year}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

async function init() {
  initUI();
  
  try {
    allBuildings = await fetchAllData();
    
    if (allBuildings.length === 0) {
      showError('No building data was returned.', 'The API returned data but no valid buildings with coordinates were found.');
      return;
    }
    
    updateYearDropdown();
    calculateDataRanges();
    filteredBuildings = allBuildings.filter(b => b.dataYear == defaultYear);
    
    showMap();
    updateSlidersFromData();
    updateStats();
    updatePropertyTypes();
    updateLegend();
    updateMap();
    
    if (filteredBuildings.length > 0) {
      const lats = filteredBuildings.map(b => b.lat);
      const lngs = filteredBuildings.map(b => b.lng);
      map.fitBounds([
        [Math.min(...lats) - 0.02, Math.min(...lngs) - 0.02],
        [Math.max(...lats) + 0.02, Math.max(...lngs) + 0.02]
      ]);
    }
    
  } catch (error) {
    console.error('Init error:', error);
    showError('Failed to load data from NYC Open Data API.', error.message);
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
